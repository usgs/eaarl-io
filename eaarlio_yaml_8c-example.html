<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>eaarl-io: eaarlio_yaml.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">eaarl-io
   &#160;<span id="projectnumber">1.0.0+33ac633</span>
   </div>
   <div id="projectbrief">EAARL Input/Output Library (Public API)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">eaarlio_yaml.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>This example is the source code for the included eaarlio_yaml program, which outputs EAARL raster data in YAML format. It provides a more comprehensive and real-world example of how to use the library than the simpler examples.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;argtable3.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="edb_8h.html">eaarlio/edb.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="error_8h.html">eaarlio/error.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="file_8h.html">eaarlio/file.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="flight_8h.html">eaarlio/flight.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="pulse_8h.html">eaarlio/pulse.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="raster_8h.html">eaarlio/raster.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="units_8h.html">eaarlio/units.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="version_8h.html">eaarlio/version.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="comment">/* Writes out a waveform as a list of integers. To improve readability,the</span></div><div class="line"><span class="comment"> * integers are written out using inline list format (i.e., in brackets) rather</span></div><div class="line"><span class="comment"> * than block list format (i.e., one value per line). Long lines are wrapped to</span></div><div class="line"><span class="comment"> * further improve readability.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The output will resemble this:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      [</span></div><div class="line"><span class="comment"> *          100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,</span></div><div class="line"><span class="comment"> *          100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,</span></div><div class="line"><span class="comment"> *          100, 100, 100, 100, 100, 100, 100</span></div><div class="line"><span class="comment"> *      ]</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> yaml_wf(FILE *out, <span class="comment">// Output filehandle</span></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *wf, <span class="comment">// Waveform to write</span></div><div class="line">    uint16_t wf_len) <span class="comment">// Length of the waveform</span></div><div class="line">{</div><div class="line">    <span class="comment">// Current index into the wf array</span></div><div class="line">    uint16_t i = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Special handling for an empty waveform</span></div><div class="line">    <span class="keywordflow">if</span>(!wf || wf_len &lt; 1) {</div><div class="line">        fprintf(out, <span class="stringliteral">&quot;[]&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// The list opens with a bracket</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;[&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span>(i = 0; i &lt; wf_len; i++) {</div><div class="line">        <span class="comment">// 12 values per line. Each line is indented.</span></div><div class="line">        <span class="keywordflow">if</span>(i % 12 == 0)</div><div class="line">            fprintf(out, <span class="stringliteral">&quot;\n            &quot;</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Write out the current value. If it&#39;s not the last, add a comma</span></div><div class="line">        fprintf(out, <span class="stringliteral">&quot; %3d&quot;</span>, wf[i]);</div><div class="line">        <span class="keywordflow">if</span>(i + 1 &lt; wf_len)</div><div class="line">            fprintf(out, <span class="stringliteral">&quot;,&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// The list closes with an indented bracket</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;\n          ]\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Write the data for a pulse</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> yaml_pulse(FILE *out, <span class="comment">// Output filehandle</span></div><div class="line">    <span class="keyword">struct</span> <a name="_a0"></a><a class="code" href="raster_8h.html#structeaarlio__raster">eaarlio_raster</a> *raster, <span class="comment">// The raster&#39;s data</span></div><div class="line">    uint16_t pulse_number, <span class="comment">// Pulse number to write</span></div><div class="line">    <span class="keywordtype">int</span> include_waveforms) <span class="comment">// Output waveforms? 1 = yes, 0 = no</span></div><div class="line">{</div><div class="line">    <span class="comment">// Sanity checks</span></div><div class="line">    assert(out);</div><div class="line">    assert(raster);</div><div class="line">    assert(raster-&gt;<a name="a1"></a><a class="code" href="raster_8h.html#ab3c415fffdb33f04acf6f41fc128fa8a">pulse</a>);</div><div class="line"></div><div class="line">    <span class="comment">// Loop counter</span></div><div class="line">    <span class="keywordtype">int</span> i = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Load the pulse of interest into a convenience variable</span></div><div class="line">    <span class="keyword">struct </span><a name="_a2"></a><a class="code" href="pulse_8h.html#structeaarlio__pulse">eaarlio_pulse</a> *pulse = &amp;raster-&gt;<a class="code" href="raster_8h.html#ab3c415fffdb33f04acf6f41fc128fa8a">pulse</a>[pulse_number - 1];</div><div class="line"></div><div class="line">    <span class="comment">// Number of waveforms, which cannot exceed the max</span></div><div class="line">    <span class="keywordtype">int</span> channels = <a name="a3"></a><a class="code" href="pulse_8h.html#a9e6b6092c7f557834bbd98428f11fbad">EAARLIO_MAX_RX_COUNT</a>;</div><div class="line">    <span class="keywordflow">if</span>(pulse-&gt;<a name="a4"></a><a class="code" href="pulse_8h.html#a0cfbb262863d03fed42d326f059e69bb">rx_count</a> &lt; channels)</div><div class="line">        channels = pulse-&gt;<a class="code" href="pulse_8h.html#a0cfbb262863d03fed42d326f059e69bb">rx_count</a>;</div><div class="line"></div><div class="line">    <span class="comment">// Each pulse is an entry in a list, so the first line has to get the</span></div><div class="line">    <span class="comment">// hyphen prefix.</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;    - pulse_number: %&quot;</span> PRIu16 <span class="stringliteral">&quot;\n&quot;</span>, pulse_number);</div><div class="line"></div><div class="line">    <span class="comment">// Time and scan angle are stored in hardware-specific formats. We include</span></div><div class="line">    <span class="comment">// the values converted into normal units as well.</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      time: %.6f\n&quot;</span>,</div><div class="line">        <a name="a5"></a><a class="code" href="units_8h.html#aecedafe693a08e1c456059119002ecb7">eaarlio_units_pulse_time</a>(raster, pulse_number));</div><div class="line">    fprintf(</div><div class="line">        out, <span class="stringliteral">&quot;      scan_angle: %.3f\n&quot;</span>, <a name="a6"></a><a class="code" href="units_8h.html#a55260dc222ed9ae7c5dceb57a515dda3">eaarlio_units_pulse_scan_angle</a>(pulse));</div><div class="line"></div><div class="line">    <span class="comment">// Values directly from the struct</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      time_offset: %&quot;</span> PRIu32 <span class="stringliteral">&quot;\n&quot;</span>, pulse-&gt;<a name="a7"></a><a class="code" href="pulse_8h.html#a78657d19933e3ef720164978a1871dba">time_offset</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      scan_angle_counts: %&quot;</span> PRIi16 <span class="stringliteral">&quot;\n&quot;</span>,</div><div class="line">        pulse-&gt;<a name="a8"></a><a class="code" href="pulse_8h.html#a0d99b582e30cb87c725f2625af7daf24">scan_angle_counts</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      range: %&quot;</span> PRIu16 <span class="stringliteral">&quot;\n&quot;</span>, pulse-&gt;<a name="a9"></a><a class="code" href="pulse_8h.html#a4a855733a250c83cef254812cf5ba6b5">range</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      rx_count: %&quot;</span> PRIu8 <span class="stringliteral">&quot;\n&quot;</span>, pulse-&gt;<a class="code" href="pulse_8h.html#a0cfbb262863d03fed42d326f059e69bb">rx_count</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      thresh_tx: %&quot;</span> PRIu8 <span class="stringliteral">&quot;\n&quot;</span>, pulse-&gt;<a name="a10"></a><a class="code" href="pulse_8h.html#aeead43d3d4affc458c3c963a786f8ef4">thresh_tx</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      thresh_rx: %&quot;</span> PRIu8 <span class="stringliteral">&quot;\n&quot;</span>, pulse-&gt;<a name="a11"></a><a class="code" href="pulse_8h.html#ae94992b679ef23b8c1a99ec4f1bf79ae">thresh_rx</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      bias_tx: %&quot;</span> PRIu8 <span class="stringliteral">&quot;\n&quot;</span>, pulse-&gt;<a name="a12"></a><a class="code" href="pulse_8h.html#a4b38fb4c23295a2fe88e1aeae6f5cbb2">bias_tx</a>);</div><div class="line"></div><div class="line">    <span class="comment">// The bias_rx field always has four values, regardless of rx_count</span></div><div class="line">    fprintf(out,</div><div class="line">        <span class="stringliteral">&quot;      bias_rx: [%&quot;</span> PRIu8 <span class="stringliteral">&quot;, %&quot;</span> PRIu8 <span class="stringliteral">&quot;, %&quot;</span> PRIu8 <span class="stringliteral">&quot;, %&quot;</span> PRIu8 <span class="stringliteral">&quot;]\n&quot;</span>,</div><div class="line">        pulse-&gt;<a name="a13"></a><a class="code" href="pulse_8h.html#ad6bc01f6a1c81273b15208bfda6e2dcf">bias_rx</a>[0], pulse-&gt;<a class="code" href="pulse_8h.html#ad6bc01f6a1c81273b15208bfda6e2dcf">bias_rx</a>[1], pulse-&gt;<a class="code" href="pulse_8h.html#ad6bc01f6a1c81273b15208bfda6e2dcf">bias_rx</a>[2],</div><div class="line">        pulse-&gt;<a class="code" href="pulse_8h.html#ad6bc01f6a1c81273b15208bfda6e2dcf">bias_rx</a>[3]);</div><div class="line"></div><div class="line">    <span class="comment">// If we don&#39;t want waveforms, we&#39;re done</span></div><div class="line">    <span class="keywordflow">if</span>(!include_waveforms)</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Output the transmit waveform</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;      tx: &quot;</span>);</div><div class="line">    yaml_wf(out, pulse-&gt;<a name="a14"></a><a class="code" href="pulse_8h.html#aaced1c4738bfb8daea972382cc78ac21">tx</a>, pulse-&gt;<a name="a15"></a><a class="code" href="pulse_8h.html#a95e54a03baa130a919bf4554192aacf3">tx_len</a>);</div><div class="line"></div><div class="line">    <span class="comment">// Output the return waveforms, if there are any</span></div><div class="line">    <span class="keywordflow">if</span>(!pulse-&gt;<a name="a16"></a><a class="code" href="pulse_8h.html#ae8cccb2a4adf73cfdca0b9c6579a508b">rx</a> || pulse-&gt;<a class="code" href="pulse_8h.html#a0cfbb262863d03fed42d326f059e69bb">rx_count</a> &lt; 1) {</div><div class="line">        fprintf(out, <span class="stringliteral">&quot;      rx: []\n&quot;</span>);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        fprintf(out, <span class="stringliteral">&quot;      rx:\n&quot;</span>);</div><div class="line">        <span class="keywordflow">for</span>(i = 0; i &lt; channels; i++) {</div><div class="line">            fprintf(out, <span class="stringliteral">&quot;        - &quot;</span>);</div><div class="line">            yaml_wf(out, pulse-&gt;<a class="code" href="pulse_8h.html#ae8cccb2a4adf73cfdca0b9c6579a508b">rx</a>[i], pulse-&gt;<a name="a17"></a><a class="code" href="pulse_8h.html#aacfff6932d0876682ef6c67af2ff590c">rx_len</a>[i]);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Write the data for a pulse</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> yaml_raster(FILE *out, <span class="comment">// Output filehandle</span></div><div class="line">    <span class="keywordtype">int</span> raster_number, <span class="comment">// Raster number for this raster</span></div><div class="line">    <span class="keyword">struct</span> <a class="code" href="raster_8h.html#structeaarlio__raster">eaarlio_raster</a> *raster, <span class="comment">// The raster number for this raster</span></div><div class="line">    int32_t <a class="code" href="pulse_8h.html#a78657d19933e3ef720164978a1871dba">time_offset</a>, <span class="comment">// Time offset from EDB data</span></div><div class="line">    <span class="keywordtype">int</span> include_pulses, <span class="comment">// Output pulses? 1 = yes, 0 = no</span></div><div class="line">    <span class="keywordtype">int</span> include_waveforms) <span class="comment">// Output waveforms? 1 = yes, 0 = no</span></div><div class="line">{</div><div class="line">    <span class="comment">// Sanity</span></div><div class="line">    assert(out);</div><div class="line">    assert(raster);</div><div class="line"></div><div class="line">    <span class="comment">// Loop variable for pulses</span></div><div class="line">    uint16_t pulse_number;</div><div class="line"></div><div class="line">    <span class="comment">// Each raster is an entry in a list, so the first line has to get the</span></div><div class="line">    <span class="comment">// hyphen prefix.</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;- raster_number: %d\n&quot;</span>, raster_number);</div><div class="line"></div><div class="line">    <span class="comment">// Time is stored in a hardware-specific format. We include the time in</span></div><div class="line">    <span class="comment">// normal units as well.</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;  time: %.6f\n&quot;</span>, <a name="a18"></a><a class="code" href="units_8h.html#a9b3509232378113b276e5e7c711cb911">eaarlio_units_raster_time</a>(raster));</div><div class="line"></div><div class="line">    <span class="comment">// Time offset supplied by the EDB file.</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;  edb_time_offset: %&quot;</span> PRIi32 <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="pulse_8h.html#a78657d19933e3ef720164978a1871dba">time_offset</a>);</div><div class="line"></div><div class="line">    <span class="comment">// Values directly from the struct</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;  time_seconds: %&quot;</span> PRIu32 <span class="stringliteral">&quot;\n&quot;</span>, raster-&gt;<a name="a19"></a><a class="code" href="raster_8h.html#a384010bb48a459495d7bd8599b155c46">time_seconds</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;  time_fraction: %&quot;</span> PRIu32 <span class="stringliteral">&quot;\n&quot;</span>, raster-&gt;<a name="a20"></a><a class="code" href="raster_8h.html#ae556ebbdf94d4b845ca7186f3bf794a2">time_fraction</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;  sequence_number: %&quot;</span> PRIu32 <span class="stringliteral">&quot;\n&quot;</span>, raster-&gt;<a name="a21"></a><a class="code" href="raster_8h.html#a3416f691bc2370ea8922a4ad62354473">sequence_number</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;  digitizer: %&quot;</span> PRIu8 <span class="stringliteral">&quot;\n&quot;</span>, raster-&gt;<a name="a22"></a><a class="code" href="raster_8h.html#a2dbc5b39311d92b809abaa5ec304bc7a">digitizer</a>);</div><div class="line">    fprintf(out, <span class="stringliteral">&quot;  pulse_count: %&quot;</span> PRIu16 <span class="stringliteral">&quot;\n&quot;</span>, raster-&gt;<a name="a23"></a><a class="code" href="raster_8h.html#ac6c272d822b4688d40e5627449615386">pulse_count</a>);</div><div class="line"></div><div class="line">    <span class="comment">// If we don&#39;t want pulses, we&#39;re done</span></div><div class="line">    <span class="keywordflow">if</span>(!include_pulses)</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Output the pulses, if there are any</span></div><div class="line">    <span class="keywordflow">if</span>(!raster-&gt;<a class="code" href="raster_8h.html#ab3c415fffdb33f04acf6f41fc128fa8a">pulse</a> || raster-&gt;<a class="code" href="raster_8h.html#ac6c272d822b4688d40e5627449615386">pulse_count</a> &lt; 1) {</div><div class="line">        fprintf(out, <span class="stringliteral">&quot;  pulses: []\n&quot;</span>);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        fprintf(out, <span class="stringliteral">&quot;  pulses:\n&quot;</span>);</div><div class="line">        <span class="keywordflow">for</span>(pulse_number = 1; pulse_number &lt;= raster-&gt;<a class="code" href="raster_8h.html#ac6c272d822b4688d40e5627449615386">pulse_count</a>;</div><div class="line">            pulse_number++) {</div><div class="line">            <span class="comment">// Put a blank line before every pulse except the first, for</span></div><div class="line">            <span class="comment">// readability</span></div><div class="line">            <span class="keywordflow">if</span>(pulse_number &gt; 1)</div><div class="line">                fprintf(out, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line">            yaml_pulse(out, raster, pulse_number, include_waveforms);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Precheck requested raster numbers against EDB. Drop bad rasters and return</span></div><div class="line"><span class="comment"> * the number of rasters kept.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The raster numbers are prechecked to remove invalid or problematic rasters</span></div><div class="line"><span class="comment"> * using the following criteria:</span></div><div class="line"><span class="comment"> *  - Raster numbers must be between 1 and the maximum raster number from the</span></div><div class="line"><span class="comment"> *    EDB</span></div><div class="line"><span class="comment"> *  - The EDB record must reference a valid TLD file (i.e, its file index must</span></div><div class="line"><span class="comment"> *    be between 1 and the maximum file index from the EDB)</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * If problems are encountered, warnings are written to stderr. The</span></div><div class="line"><span class="comment"> * raster_numbers array is updated in-place to remove raster numbers with</span></div><div class="line"><span class="comment"> * problems. The number of raster numbers that passed the checks is returned.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> precheck_rasters(<span class="keyword">struct</span> <a name="_a24"></a><a class="code" href="edb_8h.html#structeaarlio__edb">eaarlio_edb</a> *edb, <span class="comment">// EDB data to reference</span></div><div class="line">    <span class="keywordtype">int</span> *raster_numbers, <span class="comment">// Raster numbers requested</span></div><div class="line">    <span class="keywordtype">int</span> raster_numbers_count) <span class="comment">// Size of raster_numbers</span></div><div class="line">{</div><div class="line">    <span class="comment">// Sanity</span></div><div class="line">    assert(edb);</div><div class="line">    assert(raster_numbers);</div><div class="line"></div><div class="line">    <span class="comment">// Index into raster_numbers for the raster being checked</span></div><div class="line">    <span class="keywordtype">int</span> src = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Index into raster_numbers where the next valid raster goes</span></div><div class="line">    <span class="keywordtype">int</span> dst = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Current raster number</span></div><div class="line">    <span class="keywordtype">int</span> raster_number;</div><div class="line"></div><div class="line">    <span class="comment">// Current file index</span></div><div class="line">    <span class="keywordtype">int</span> file_index;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span>(src = 0; src &lt; raster_numbers_count; src++) {</div><div class="line">        <span class="comment">// Bounds check on raster number</span></div><div class="line">        raster_number = raster_numbers[src];</div><div class="line">        <span class="keywordflow">if</span>(raster_number &lt; 1) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;WARNING: rasters must be &gt;= 1, skipping: %d\n&quot;</span>,</div><div class="line">                raster_number);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)raster_number &gt; edb-&gt;<a name="a25"></a><a class="code" href="edb_8h.html#afffd6d016f0a88573f12f71a8e594109">record_count</a>) {</div><div class="line">            fprintf(stderr,</div><div class="line">                <span class="stringliteral">&quot;WARNING: raster number beyond end of EDB, skipping: %d\n&quot;</span>,</div><div class="line">                raster_number);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Bounds check on file_index</span></div><div class="line">        file_index = edb-&gt;<a name="a26"></a><a class="code" href="edb_8h.html#a7d30cb646c803304e8bfad73e617dff3">records</a>[raster_number - 1].<a name="a27"></a><a class="code" href="edb_8h.html#a1fe476ec1abe3f0987e8dd28e074073f">file_index</a>;</div><div class="line">        <span class="keywordflow">if</span>(file_index &lt; 1) {</div><div class="line">            fprintf(stderr,</div><div class="line">                <span class="stringliteral">&quot;WARNING: EDB for raster %d references negative file_index of &quot;</span></div><div class="line">                <span class="stringliteral">&quot;%d\n&quot;</span>,</div><div class="line">                raster_number, file_index);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)file_index &gt; edb-&gt;<a name="a28"></a><a class="code" href="edb_8h.html#ad53104bea017c61ccf39992c06e2ac5c">file_count</a>) {</div><div class="line">            fprintf(stderr,</div><div class="line">                <span class="stringliteral">&quot;WARNING: EDB for raster %d references file_index of %d, max &quot;</span></div><div class="line">                <span class="stringliteral">&quot;is %d\n&quot;</span>,</div><div class="line">                raster_number, file_index, edb-&gt;<a class="code" href="edb_8h.html#ad53104bea017c61ccf39992c06e2ac5c">file_count</a>);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Keep the raster if the checks passed</span></div><div class="line">        raster_numbers[dst] = raster_number;</div><div class="line">        dst++;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Return the number of rasters kept</span></div><div class="line">    <span class="keywordflow">return</span> dst;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Outputs YAML for the rasters requested. Returns 0 on success, 1 on failure.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> eaarlio_yaml(</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *out_file, <span class="comment">/* Output YAML file to create; NULL for stdout */</span></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *edb_file, <span class="comment">/* EDB file to load for the flight */</span></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *tld_path, <span class="comment">/* Path to the TLD files */</span></div><div class="line">    <span class="keywordtype">int</span> *raster_numbers, <span class="comment">/* Array of raster numbers to read */</span></div><div class="line">    <span class="keywordtype">int</span> raster_numbers_count, <span class="comment">/* Length of raster_numbers array */</span></div><div class="line">    <span class="keywordtype">int</span> include_pulses, <span class="comment">/* Output pulse data? 1 = yes, 0 = no */</span></div><div class="line">    <span class="keywordtype">int</span> include_waveforms) <span class="comment">/* Output waveform data? 1 = yes, 0 = no */</span></div><div class="line">{</div><div class="line">    <span class="comment">// Sanity</span></div><div class="line">    assert(edb_file);</div><div class="line">    assert(raster_numbers);</div><div class="line"></div><div class="line">    <span class="comment">// Return value from eaarlio functions</span></div><div class="line">    <a class="code" href="error_8h.html#ab521cfac8459159183fdbe58c1db55da">eaarlio_error</a> err;</div><div class="line"></div><div class="line">    <span class="comment">// Have we failed? Not yet.</span></div><div class="line">    <span class="keywordtype">int</span> failed = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Flight for the EDB</span></div><div class="line">    <span class="keyword">struct </span><a name="_a29"></a><a class="code" href="flight_8h.html#structeaarlio__flight">eaarlio_flight</a> flight = <a name="a30"></a><a class="code" href="flight_8h.html#a5b142e861159d180dbd0f00897a041d7">eaarlio_flight_empty</a>();</div><div class="line"></div><div class="line">    <span class="comment">// Current raster data</span></div><div class="line">    <span class="keyword">struct </span><a class="code" href="raster_8h.html#structeaarlio__raster">eaarlio_raster</a> raster = <a name="a31"></a><a class="code" href="raster_8h.html#a2f45d28ce97a52c4a2758ec0373f6884">eaarlio_raster_empty</a>();</div><div class="line"></div><div class="line">    <span class="comment">// Time offset applied in the EDB data</span></div><div class="line">    int32_t time_offset = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Current raster number</span></div><div class="line">    <span class="keywordtype">int</span> raster_number = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Loop variable</span></div><div class="line">    <span class="keywordtype">int</span> i = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Output filehandle; defaults to stdout</span></div><div class="line">    FILE *out = stdout;</div><div class="line"></div><div class="line">    <span class="comment">// Open the output file if the user provided one</span></div><div class="line">    <span class="keywordflow">if</span>(out_file) {</div><div class="line">        out = fopen(out_file, <span class="stringliteral">&quot;w&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(!out) {</div><div class="line">            fprintf(</div><div class="line">                stderr, <span class="stringliteral">&quot;ERROR: Unable to open output file: %s\n&quot;</span>, out_file);</div><div class="line">            failed = 1;</div><div class="line">            <span class="keywordflow">goto</span> exit;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    err = <a name="a32"></a><a class="code" href="file_8h.html#af2f4a0049e65aa76c228768509466683">eaarlio_file_flight</a>(&amp;flight, edb_file, tld_path, NULL);</div><div class="line">    failed = <a name="a33"></a><a class="code" href="error_8h.html#ab3073419cbaa1745606d2caa6fecec8c">eaarlio_error_check</a>(err, <span class="stringliteral">&quot;ERROR: Problem loading EDB&quot;</span>);</div><div class="line">    <span class="keywordflow">if</span>(failed)</div><div class="line">        <span class="keywordflow">goto</span> exit;</div><div class="line"></div><div class="line">    <span class="comment">// Check for and remove problematic raster numbers</span></div><div class="line">    raster_numbers_count =</div><div class="line">        precheck_rasters(&amp;flight.<a name="a34"></a><a class="code" href="flight_8h.html#a7f3a2b3b73cb255eacc7eab6c9f7a557">edb</a>, raster_numbers, raster_numbers_count);</div><div class="line">    <span class="keywordflow">if</span>(raster_numbers_count &lt; 1) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;WARNING: no valid rasters were detected\n&quot;</span>);</div><div class="line">        <span class="keywordflow">goto</span> exit;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Start the YAML document</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;---\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span>(i = 0; i &lt; raster_numbers_count; i++) {</div><div class="line">        <span class="comment">// Put a blank line before every raster except the first, for</span></div><div class="line">        <span class="comment">// readability</span></div><div class="line">        <span class="keywordflow">if</span>(i &gt; 0)</div><div class="line">            fprintf(out, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"></div><div class="line">        raster_number = raster_numbers[i];</div><div class="line"></div><div class="line">        err = <a name="a35"></a><a class="code" href="flight_8h.html#a44607c75a5551ccb8402bec5323f8673">eaarlio_flight_read_raster</a>(&amp;flight, &amp;raster, &amp;time_offset,</div><div class="line">            raster_number, include_pulses, include_waveforms);</div><div class="line">        failed = <a class="code" href="error_8h.html#ab3073419cbaa1745606d2caa6fecec8c">eaarlio_error_check</a>(</div><div class="line">            err, <span class="stringliteral">&quot;ERROR: Problem reading raster %d&quot;</span>, raster_number);</div><div class="line">        <span class="keywordflow">if</span>(failed)</div><div class="line">            <span class="keywordflow">goto</span> exit;</div><div class="line"></div><div class="line">        <span class="comment">// Generate the YAML for the raster</span></div><div class="line">        yaml_raster(out, raster_number, &amp;raster, time_offset, include_pulses,</div><div class="line">            include_waveforms);</div><div class="line"></div><div class="line">        err = <a name="a36"></a><a class="code" href="raster_8h.html#a8c512991930c39d9ded3c434d37af149">eaarlio_raster_free</a>(&amp;raster, NULL);</div><div class="line">        failed = <a class="code" href="error_8h.html#ab3073419cbaa1745606d2caa6fecec8c">eaarlio_error_check</a>(</div><div class="line">            err, <span class="stringliteral">&quot;ERROR: Problem releasing memory for raster&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(failed)</div><div class="line">            <span class="keywordflow">goto</span> exit;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// End the YAML document</span></div><div class="line">    fprintf(out, <span class="stringliteral">&quot;...\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Close the output file (but don&#39;t close stdout)</span></div><div class="line">    <span class="keywordflow">if</span>(out_file) {</div><div class="line">        failed = fclose(out);</div><div class="line">        out = NULL;</div><div class="line">        <span class="keywordflow">if</span>(failed) {</div><div class="line">            fprintf(</div><div class="line">                stderr, <span class="stringliteral">&quot;ERROR: Unable to close output file: %s\n&quot;</span>, out_file);</div><div class="line">            <span class="keywordflow">goto</span> exit;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    err = <a name="a37"></a><a class="code" href="flight_8h.html#a5e1b6c563a95d07226398019aa992b4d">eaarlio_flight_free</a>(&amp;flight);</div><div class="line">    failed = <a class="code" href="error_8h.html#ab3073419cbaa1745606d2caa6fecec8c">eaarlio_error_check</a>(</div><div class="line">        err, <span class="stringliteral">&quot;ERROR: Problem releasing resouces for the flight&quot;</span>);</div><div class="line">    <span class="keywordflow">if</span>(failed)</div><div class="line">        <span class="keywordflow">goto</span> exit;</div><div class="line"></div><div class="line">exit:</div><div class="line">    <span class="comment">// Cleanup. Make sure files are closed and memory released.</span></div><div class="line">    <a class="code" href="flight_8h.html#a5e1b6c563a95d07226398019aa992b4d">eaarlio_flight_free</a>(&amp;flight);</div><div class="line">    <a class="code" href="raster_8h.html#a8c512991930c39d9ded3c434d37af149">eaarlio_raster_free</a>(&amp;raster, NULL);</div><div class="line">    <span class="keywordflow">if</span>(out &amp;&amp; out_file) {</div><div class="line">        fclose(out);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> failed;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* The main function handles command line arguments. It defines the command</span></div><div class="line"><span class="comment"> * line arguments accepted and parses them. It either shows an error, shows</span></div><div class="line"><span class="comment"> * usage informatino, or invokes eaarlio_yaml to do the real work.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> failed = 0, nerrors = 0;</div><div class="line">    <span class="keywordtype">char</span> progname[] = <span class="stringliteral">&quot;eaarlio_yaml&quot;</span>;</div><div class="line">    <span class="keywordtype">char</span> *tld_path = NULL;</div><div class="line">    <span class="keywordtype">int</span> tld_path_free = 0;</div><div class="line"></div><div class="line">    <span class="keyword">struct </span>arg_lit *help, *version, *nopulse, *nowf;</div><div class="line">    <span class="keyword">struct </span>arg_file *outfile, *edb, *tld;</div><div class="line">    <span class="keyword">struct </span>arg_int *rasters;</div><div class="line">    <span class="keyword">struct </span>arg_end *end;</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> *argtable[] = {</div><div class="line">        help = arg_litn(<span class="stringliteral">&quot;h&quot;</span>, <span class="stringliteral">&quot;help&quot;</span>, 0, 1, <span class="stringliteral">&quot;display this help and exit&quot;</span>),</div><div class="line">        version =</div><div class="line">            arg_litn(<span class="stringliteral">&quot;V&quot;</span>, <span class="stringliteral">&quot;version&quot;</span>, 0, 1, <span class="stringliteral">&quot;display library version and exit&quot;</span>),</div><div class="line">        outfile = arg_filen(<span class="stringliteral">&quot;o&quot;</span>, <span class="stringliteral">&quot;output&quot;</span>, <span class="stringliteral">&quot;&lt;output.yaml&gt;&quot;</span>, 0, 1,</div><div class="line">            <span class="stringliteral">&quot;output file to create instead of writing to stdout&quot;</span>),</div><div class="line">        nopulse = arg_litn(</div><div class="line">            <span class="stringliteral">&quot;P&quot;</span>, <span class="stringliteral">&quot;no-pulses&quot;</span>, 0, 1, <span class="stringliteral">&quot;do not include pulse data in the output&quot;</span>),</div><div class="line">        nowf = arg_litn(<span class="stringliteral">&quot;W&quot;</span>, <span class="stringliteral">&quot;no-waveforms&quot;</span>, 0, 1,</div><div class="line">            <span class="stringliteral">&quot;do not include waveform data in the output&quot;</span>),</div><div class="line">        tld = arg_file0(<span class="stringliteral">&quot;t&quot;</span>, <span class="stringliteral">&quot;tld&quot;</span>, <span class="stringliteral">&quot;&lt;tld path&gt;&quot;</span>, <span class="stringliteral">&quot;path to the TLD files&quot;</span>),</div><div class="line">        edb = arg_filen(NULL, NULL, <span class="stringliteral">&quot;&lt;edb file&gt;&quot;</span>, 1, 1, <span class="stringliteral">&quot;EDB file for dataset&quot;</span>),</div><div class="line">        rasters = arg_intn(</div><div class="line">            NULL, NULL, <span class="stringliteral">&quot;&lt;raster number&gt;&quot;</span>, 1, 1000, <span class="stringliteral">&quot;raster numbers to export&quot;</span>),</div><div class="line">        end = arg_end(20),</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(arg_nullcheck(argtable) != 0) {</div><div class="line">        printf(<span class="stringliteral">&quot;error: insufficient memory\n&quot;</span>);</div><div class="line">        failed = 1;</div><div class="line">        <span class="keywordflow">goto</span> exit;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Output filename defaults to NULL for stdout</span></div><div class="line">    outfile-&gt;filename[0] = NULL;</div><div class="line"></div><div class="line">    <span class="comment">// Parse the command line</span></div><div class="line">    nerrors = arg_parse(argc, argv, argtable);</div><div class="line"></div><div class="line">    <span class="comment">// Display version number if --version is requested</span></div><div class="line">    <span class="keywordflow">if</span>(version-&gt;count &gt; 0) {</div><div class="line">        printf(<span class="stringliteral">&quot;%s\n&quot;</span>, <a name="a38"></a><a class="code" href="version_8h.html#a38a9129ad5fb0bb07b8814c66f0964d5">EAARLIO_VERSION</a>);</div><div class="line">        failed = 0;</div><div class="line">        <span class="keywordflow">goto</span> exit;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Show usage information if --help is requested</span></div><div class="line">    <span class="keywordflow">if</span>(help-&gt;count &gt; 0) {</div><div class="line">        printf(<span class="stringliteral">&quot;Usage: %s&quot;</span>, progname);</div><div class="line">        arg_print_syntax(stdout, argtable, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;Export rasters in YAML format.\n\n&quot;</span>);</div><div class="line">        arg_print_glossary(stdout, argtable, <span class="stringliteral">&quot;  %-25s %s\n&quot;</span>);</div><div class="line">        printf(</div><div class="line">            <span class="stringliteral">&quot;\n&quot;</span></div><div class="line">            <span class="stringliteral">&quot;Exports the rasters in YAML format as requested...\n&quot;</span>);</div><div class="line">        failed = 0;</div><div class="line">        <span class="keywordflow">goto</span> exit;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Display errors if invalid args were given</span></div><div class="line">    <span class="keywordflow">if</span>(nerrors &gt; 0) {</div><div class="line">        arg_print_errors(stderr, end, progname);</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Try &#39;%s --help&#39; for more information.\n&quot;</span>, progname);</div><div class="line">        failed = 1;</div><div class="line">        <span class="keywordflow">goto</span> exit;</div><div class="line">    }</div><div class="line"></div><div class="line">    assert(strlen(edb-&gt;filename[0]) &gt; 0);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(tld-&gt;count &gt; 0) {</div><div class="line">        tld_path = (<span class="keywordtype">char</span> *)tld-&gt;filename[0];</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strlen(edb-&gt;basename[0]) &lt; strlen(edb-&gt;filename[0])) {</div><div class="line">        tld_path_free = 1;</div><div class="line">        tld_path = calloc(strlen(edb-&gt;filename[0] + 1), <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));</div><div class="line">        <span class="keywordflow">if</span>(!tld_path) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Memory allocation failure\n&quot;</span>);</div><div class="line">            failed = 1;</div><div class="line">            <span class="keywordflow">goto</span> exit;</div><div class="line">        }</div><div class="line">        strcpy(tld_path, edb-&gt;filename[0]);</div><div class="line">        tld_path[strlen(edb-&gt;filename[0]) - strlen(edb-&gt;basename[0])] = 0;</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        tld_path = <span class="stringliteral">&quot;.&quot;</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Pass the parsed args to @ref eaarlio_yaml to do the real work</span></div><div class="line">    failed = eaarlio_yaml(outfile-&gt;filename[0], edb-&gt;filename[0], tld_path,</div><div class="line">        rasters-&gt;ival, rasters-&gt;count, nopulse-&gt;count == 0, nowf-&gt;count == 0);</div><div class="line"></div><div class="line">exit:</div><div class="line">    <span class="comment">// Cleanup: release memory</span></div><div class="line">    arg_freetable(argtable, <span class="keyword">sizeof</span>(argtable) / <span class="keyword">sizeof</span>(argtable[0]));</div><div class="line">    <span class="keywordflow">if</span>(tld_path_free &amp;&amp; tld_path)</div><div class="line">        free(tld_path);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> failed;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
